<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GhostDiscord Elite</title>
    <style>
        :root { --neon: #00ff41; --bg-dark: #1e1f22; --bg-light: #313338; --bg-sidebar: #2b2d31; }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body { 
            background: #000; color: #fff; font-family: sans-serif; 
            margin: 0; padding: 0; height: 100%; width: 100%;
            overflow: hidden; position: fixed;
        }
        
        /* Main Wrapper */
        #app { 
            display: flex; 
            height: 100dvh; 
            width: 100vw; 
            position: relative; 
            flex-direction: row;
        }

        .blur-active { filter: blur(60px) brightness(0); pointer-events: none; }

        /* Left Sidebars */
        .servers { width: 60px; background: #1e1f22; display: flex; flex-direction: column; align-items: center; padding: 10px 0; gap: 10px; border-right: 1px solid #000; overflow-y: auto; }
        .sidebar { width: 140px; background: var(--bg-sidebar); display: flex; flex-direction: column; border-right: 1px solid #000; flex-shrink: 0; }
        
        .server-icon { 
            width: 40px; height: 40px; background: var(--bg-light); border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; font-weight: bold; font-size: 10px; flex-shrink: 0;
            color: #fff;
        }
        .active-srv { border-radius: 12px; background: var(--neon); color: #000; }

        .section-label { padding: 15px 10px 5px 10px; font-size: 9px; font-weight: bold; color: #8e9297; text-transform: uppercase; }
        .item { padding: 10px; margin: 2px 5px; border-radius: 4px; color: #949ba4; cursor: pointer; font-size: 12px; white-space: nowrap; overflow: hidden; }
        .active-item { background: #35373c; color: #fff; border-left: 2px solid var(--neon); }

        /* Chat Layout */
        .chat-container { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            background: var(--bg-light); 
            min-width: 0;
            height: 100%;
        }

        #msg-flow { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 12px;
            -webkit-overflow-scrolling: touch;
        }

        /* Message Bar - Bolted to Bottom */
        .input-area { 
            flex-shrink: 0;
            padding: 10px; 
            background: var(--bg-dark); 
            border-top: 1px solid #000;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
        }

        input { 
            width: 100%; background: #383a40; border: none; padding: 15px; 
            border-radius: 8px; color: #fff; outline: none; font-size: 16px; 
        }

        .msg-card { background: #2b2d31; padding: 10px; border-radius: 8px; border-left: 3px solid var(--neon); }
        .msg-meta { font-size: 9px; color: var(--neon); margin-bottom: 5px; }
        .show-btn { background: var(--neon); color: #000; border: none; padding: 10px; border-radius: 4px; font-weight: bold; width: 100%; }
        .secret-content { display: none; font-family: monospace; padding: 10px; background: #000; border-radius: 4px; word-break: break-all; }

        /* Lockdown Screen */
        #lockdown { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; z-index: 9999; display: none; 
            flex-direction: column; justify-content: center; align-items: center; 
            color: var(--neon); text-align: center;
        }
    </style>
</head>
<body>

<div id="lockdown" onclick="releaseLock()">
    <h1 style="margin:0">ENCRYPTED</h1>
    <p style="font-size:12px">INTERFERENCE DETECTED (VOLUME/SCREENSHOT)<br>TAP TO UNLOCK</p>
</div>

<div id="app">
    <div class="servers" id="server-list">
        <div class="server-icon active-srv" onclick="switchServer('main', this)">M</div>
        <div class="server-icon" onclick="addServer()" style="background:#23a559">+</div>
    </div>
    
    <div class="sidebar">
        <div class="section-label" id="srv-name">MAIN</div>
        <div class="item active-item" onclick="switchChannel('general', this)"># general</div>
        <div class="section-label">Friends</div>
        <div id="friend-list"></div>
        <div class="item" onclick="addFriend()" style="color:var(--neon)">+ ADD</div>
    </div>

    <div class="chat-container">
        <div id="msg-flow"></div>
        <div class="input-area">
            <input type="text" id="userInput" placeholder="Message..." autocomplete="off">
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const S_URL = 'https://ddtrbxfyhgnbairjdbmk.supabase.co';
    const S_KEY = 'sb_publishable_RvgTk4dJ4ia0lJaPp8Wvaw_xuy48EuH';
    const db = supabase.createClient(S_URL, S_KEY);

    let myUser = localStorage.getItem('ghost_user') || prompt("Username:");
    localStorage.setItem('ghost_user', myUser || "Ghost");

    let curServer = 'main';
    let curChannel = 'general';
    let lastHeight = window.innerHeight;

    // --- HARDWARE / SCREENSHOT LOCK ---
    function triggerLock() {
        document.getElementById('lockdown').style.display = 'flex';
        document.getElementById('app').classList.add('blur-active');
    }

    function releaseLock() {
        document.getElementById('lockdown').style.display = 'none';
        document.getElementById('app').classList.remove('blur-active');
    }

    // Detect hardware triggers (Volume bars/Screenshot menus usually resize the window)
    window.addEventListener('resize', () => {
        if (Math.abs(window.innerHeight - lastHeight) > 30) {
            triggerLock();
        }
        lastHeight = window.innerHeight;
    });

    window.addEventListener('blur', triggerLock);

    // --- CIPHER ---
    const alphabet = "abcdefghijklmnopqrstuvwxyz0123456789 .?!@#".split("");
    const custom = "αβγδεζηθικλμνξοπρστυφχψω⚡∆∑∏√∞∫≈≠≤≥★☣".split("");

    function cipher(t, k, d = false) {
        let r = ""; let s = d ? -k : k;
        for (let c of t.toLowerCase()) {
            let src = d ? custom : alphabet; let tar = d ? alphabet : custom;
            let i = src.indexOf(c); if (i === -1) { r += c; continue; }
            r += tar[(i + s + src.length) % src.length];
        }
        return r;
    }

    // --- CORE LOGIC ---
    function addServer() {
        const n = prompt("Server Name:");
        if(n) {
            const s = JSON.parse(localStorage.getItem('ghost_servers') || "[]");
            s.push(n);
            localStorage.setItem('ghost_servers', JSON.stringify(s));
            renderServers();
        }
    }

    function renderServers() {
        const list = JSON.parse(localStorage.getItem('ghost_servers') || "[]");
        const cont = document.getElementById('server-list');
        while(cont.children.length > 2) cont.removeChild(cont.children[1]);
        list.forEach(s => {
            const div = document.createElement('div');
            div.className = 'server-icon';
            div.innerText = s[0].toUpperCase();
            div.onclick = () => switchServer(s);
            cont.insertBefore(div, cont.lastElementChild);
        });
    }

    function switchServer(id) {
        curServer = id;
        document.getElementById('srv-name').innerText = id.toUpperCase();
        document.getElementById('msg-flow').innerHTML = "";
        loadHistory();
    }

    function switchChannel(id, el) {
        curChannel = id;
        document.querySelectorAll('.item').forEach(i => i.classList.remove('active-item'));
        el.classList.add('active-item');
        document.getElementById('msg-flow').innerHTML = "";
        loadHistory();
    }

    db.channel('elite').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, p => {
        if(p.new.server_id === curServer && p.new.channel_name === curChannel) renderMsg(p.new);
    }).subscribe();

    async function loadHistory() {
        const { data } = await db.from('messages').select('*').eq('server_id', curServer).is('viewed_at', null);
        if(data) data.forEach(renderMsg);
    }

    function renderMsg(m) {
        const div = document.createElement('div');
        div.className = 'msg-card';
        div.id = `msg-${m.id}`;
        div.innerHTML = `<div class="msg-meta">${m.username}</div><button class="show-btn" onclick="reveal('${m.id}','${m.content}',${m.secret_key})">VIEW (3s)</button><div class="secret-content" id="t-${m.id}"></div>`;
        document.getElementById('msg-flow').appendChild(div);
        document.getElementById('msg-flow').scrollTop = document.getElementById('msg-flow').scrollHeight;
    }

    async function reveal(id, content, key) {
        await db.from('messages').update({ viewed_at: new Date() }).eq('id', id);
        const t = document.getElementById(`t-${id}`);
        t.innerText = cipher(content, key, true);
        t.style.display = 'block';
        setTimeout(() => { if(document.getElementById(`msg-${id}`)) document.getElementById(`msg-${id}`).remove(); }, 3000);
    }

    document.getElementById('userInput').addEventListener('keypress', async (e) => {
        if(e.key === 'Enter' && e.target.value) {
            const v = e.target.value; e.target.value = '';
            const k = Math.floor(Math.random() * 20) + 1;
            await db.from('messages').insert([{ content: cipher(v, k), secret_key: k, username: myUser, server_id: curServer, channel_name: curChannel }]);
        }
    });

    renderServers();
    loadHistory();
</script>
</body>
</html>
