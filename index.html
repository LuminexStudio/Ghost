<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GhostDiscord Elite Ultra</title>
    <style>
        :root { --neon: #00ff41; --bg-dark: #1e1f22; --bg-light: #313338; --bg-sidebar: #2b2d31; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'gg sans', sans-serif; }
        body, html { background: #000; color: #fff; margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; position: fixed; }
        
        #app { display: flex; height: 100dvh; width: 100vw; position: relative; }
        .blur-active { filter: blur(60px) brightness(0); pointer-events: none; }

        /* Left Sidebars */
        .rail { width: 60px; background: #1e1f22; display: flex; flex-direction: column; align-items: center; padding: 10px 0; gap: 10px; border-right: 1px solid #000; overflow-y: auto; flex-shrink: 0; }
        .sidebar { width: 160px; background: var(--bg-sidebar); display: flex; flex-direction: column; border-right: 1px solid #000; flex-shrink: 0; }
        
        .circle { width: 42px; height: 42px; background: var(--bg-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; font-size: 10px; color: #fff; flex-shrink: 0; }
        .active-srv { border-radius: 12px; background: var(--neon); color: #000; }

        .section-label { padding: 15px 10px 5px 10px; font-size: 9px; font-weight: bold; color: #8e9297; text-transform: uppercase; display: flex; justify-content: space-between; }
        .item { padding: 8px 10px; margin: 2px 5px; border-radius: 4px; color: #949ba4; cursor: pointer; font-size: 12px; white-space: nowrap; overflow: hidden; display: flex; align-items: center; gap: 5px; }
        .active-item { background: #35373c; color: #fff; border-left: 2px solid var(--neon); }

        /* Status Dot */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #23a559; }

        /* Chat Layout */
        .chat-container { flex: 1; display: flex; flex-direction: column; background: var(--bg-light); min-width: 0; height: 100%; }
        #msg-flow { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }

        /* Message Cards */
        .msg-card { background: #2b2d31; padding: 10px; border-radius: 8px; border-left: 3px solid var(--neon); animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .msg-meta { font-size: 9px; color: var(--neon); margin-bottom: 5px; display: flex; justify-content: space-between; }
        .show-btn { background: var(--neon); color: #000; border: none; padding: 8px; border-radius: 4px; font-weight: bold; width: 100%; cursor: pointer; }
        .secret-content { display: none; font-family: monospace; padding: 10px; background: #000; border-radius: 4px; word-break: break-all; margin-top: 5px; color: var(--neon); }
        .gif-img { max-width: 100%; border-radius: 4px; margin-top: 5px; }

        /* Input Area & Picker */
        .input-area { flex-shrink: 0; padding: 10px; background: var(--bg-dark); border-top: 1px solid #000; padding-bottom: max(10px, env(safe-area-inset-bottom)); position: relative; }
        .input-wrap { display: flex; align-items: center; background: #383a40; border-radius: 8px; padding-right: 10px; }
        input { flex: 1; background: transparent; border: none; padding: 15px; color: #fff; outline: none; font-size: 16px; }
        
        .picker { position: absolute; bottom: 80px; right: 10px; width: 280px; height: 350px; background: var(--bg-sidebar); border-radius: 8px; border: 1px solid #000; display: none; flex-direction: column; z-index: 1000; }
        .picker-res { flex: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; }

        #lockdown { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; color: var(--neon); text-align: center; }
    </style>
</head>
<body>

<div id="lockdown" onclick="releaseLock()">
    <h1>ENCRYPTED</h1>
    <p style="font-size:12px">SCREENSHOT/INTERFERENCE PREVENTION<br>TAP TO UNLOCK</p>
</div>

<div id="app">
    <div class="rail" id="server-list">
        <div class="circle active-srv" onclick="switchServer('main', this)">G</div>
        <div class="circle" onclick="addServer()" style="background:#23a559">+</div>
    </div>
    
    <div class="sidebar">
        <div class="section-label" id="srv-name">GHOST HOME</div>
        <div class="item active-item" onclick="switchChannel('general', this)"># general</div>
        
        <div class="section-label">Friends <span onclick="addFriend()" style="cursor:pointer">+</span></div>
        <div id="friend-list"></div>

        <div class="section-label">Status</div>
        <div class="item" onclick="changeStatus()">üé≠ Set Status</div>
    </div>

    <div class="chat-container">
        <div id="msg-flow"></div>
        <div class="input-area">
            <div id="picker" class="picker">
                <div style="display:flex; background:#1e1f22">
                    <div style="flex:1; padding:10px; text-align:center; cursor:pointer" onclick="loadPicker('emoji')">Emoji</div>
                    <div style="flex:1; padding:10px; text-align:center; cursor:pointer" onclick="loadPicker('gif')">GIFs</div>
                </div>
                <div id="picker-res" class="picker-res"></div>
            </div>
            <div class="input-wrap">
                <input type="text" id="userInput" placeholder="Message..." autocomplete="off">
                <div onclick="togglePicker()" style="cursor:pointer; font-size:20px">üñºÔ∏è</div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const S_URL = 'https://ddtrbxfyhgnbairjdbmk.supabase.co';
    const S_KEY = 'sb_publishable_RvgTk4dJ4ia0lJaPp8Wvaw_xuy48EuH';
    const db = supabase.createClient(S_URL, S_KEY);

    let myUser = localStorage.getItem('ghost_user') || prompt("Username:");
    localStorage.setItem('ghost_user', myUser || "Ghost");

    let curServer = 'main'; let curChannel = 'general'; let myStatus = 'online';
    const alphabet = "abcdefghijklmnopqrstuvwxyz0123456789 .?!@#".split("");
    const custom = "Œ±Œ≤Œ≥Œ¥ŒµŒ∂Œ∑Œ∏ŒπŒ∫ŒªŒºŒΩŒæŒøœÄœÅœÉœÑœÖœÜœáœàœâ‚ö°‚àÜ‚àë‚àè‚àö‚àû‚à´‚âà‚â†‚â§‚â•‚òÖ‚ò£".split("");

    // --- LOCK SYSTEM ---
    function triggerLock() { document.getElementById('lockdown').style.display = 'flex'; document.getElementById('app').classList.add('blur-active'); }
    function releaseLock() { document.getElementById('lockdown').style.display = 'none'; document.getElementById('app').classList.remove('blur-active'); }
    window.addEventListener('blur', triggerLock);

    // --- ENCRYPTION ---
    function cipher(t, k, d = false) {
        let r = ""; let s = d ? -k : k;
        for (let c of t.toLowerCase()) {
            let src = d ? custom : alphabet; let tar = d ? alphabet : custom;
            let i = src.indexOf(c); if (i === -1) { r += c; continue; }
            r += tar[(i + s + src.length) % src.length];
        }
        return r;
    }

    // --- UI HELPERS ---
    function changeStatus() {
        const s = prompt("online, idle, dnd");
        if(['online','idle','dnd'].includes(s)) myStatus = s;
    }

    function addFriend() {
        const n = prompt("Friend Name:");
        if(n) {
            const f = JSON.parse(localStorage.getItem('ghost_friends') || "[]");
            f.push(n); localStorage.setItem('ghost_friends', JSON.stringify(f));
            renderFriends();
        }
    }

    function addServer() {
        const n = prompt("Server Name:");
        if(n) {
            const s = JSON.parse(localStorage.getItem('ghost_servers') || "[]");
            s.push(n); localStorage.setItem('ghost_servers', JSON.stringify(s));
            renderServers();
        }
    }

    function renderServers() {
        const list = JSON.parse(localStorage.getItem('ghost_servers') || "[]");
        const cont = document.getElementById('server-list');
        while(cont.children.length > 2) cont.removeChild(cont.children[1]);
        list.forEach(s => {
            const div = document.createElement('div');
            div.className = 'circle'; div.innerText = s[0].toUpperCase();
            div.onclick = () => switchServer(s, div);
            cont.insertBefore(div, cont.lastElementChild);
        });
    }

    function renderFriends() {
        const list = JSON.parse(localStorage.getItem('ghost_friends') || "[]");
        const cont = document.getElementById('friend-list'); cont.innerHTML = "";
        list.forEach(f => {
            const div = document.createElement('div');
            div.className = "item"; div.innerHTML = `<div class="status-dot"></div> ${f}`;
            cont.appendChild(div);
        });
    }

    function switchServer(id, el) {
        curServer = id; document.getElementById('srv-name').innerText = id.toUpperCase();
        document.querySelectorAll('.circle').forEach(c => c.classList.remove('active-srv'));
        el.classList.add('active-srv');
        loadHistory();
    }

    function switchChannel(id, el) {
        curChannel = id; document.querySelectorAll('.item').forEach(i => i.classList.remove('active-item'));
        el.classList.add('active-item'); loadHistory();
    }

    // --- PICKER (GIF/EMOJI) ---
    function togglePicker() {
        const p = document.getElementById('picker');
        p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
        if(p.style.display === 'flex') loadPicker('emoji');
    }

    async function loadPicker(type) {
        const res = document.getElementById('picker-res'); res.innerHTML = "";
        if(type === 'emoji') {
            ["üî•","üíÄ","üëª","üëë","üíé","‚ò£Ô∏è"].forEach(e => {
                const s = document.createElement('span'); s.innerText = e; s.style.fontSize = "30px"; s.style.cursor="pointer";
                s.onclick = () => document.getElementById('userInput').value += e;
                res.appendChild(s);
            });
        } else {
            const resp = await fetch(`https://tenor.googleapis.com/v2/featured?key=LIVDSRZULEUB&limit=8`);
            const data = await resp.json();
            data.results.forEach(g => {
                const img = document.createElement('img'); img.src = g.media_formats.tinygif.url; img.className="gif-img"; img.style.cursor="pointer";
                img.onclick = () => sendMsg(g.media_formats.gif.url, true);
                res.appendChild(img);
            });
        }
    }

    // --- DATABASE ---
    async function sendMsg(content, isGif = false) {
        const k = Math.floor(Math.random() * 20) + 1;
        const payload = {
            content: isGif ? content : cipher(content, k),
            secret_key: k.toString(),
            username: myUser,
            server_id: curServer,
            channel_name: curChannel,
            is_gif: isGif,
            status_type: myStatus
        };
        await db.from('messages').insert([payload]);
        document.getElementById('picker').style.display = 'none';
    }

    function renderMsg(m) {
        if(document.getElementById(`msg-${m.id}`)) return;
        const div = document.createElement('div');
        div.className = 'msg-card'; div.id = `msg-${m.id}`;
        div.innerHTML = `
            <div class="msg-meta"><span>${m.username}</span><span>${m.status_type}</span></div>
            <button class="show-btn" id="btn-${m.id}" onclick="reveal('${m.id}','${m.content}',${m.secret_key},${m.is_gif})">VIEW (3s)</button>
            <div class="secret-content" id="t-${m.id}"></div>
        `;
        const flow = document.getElementById('msg-flow');
        flow.appendChild(div); flow.scrollTop = flow.scrollHeight;
    }

    async function reveal(id, content, key, isGif) {
        await db.from('messages').update({ viewed_at: new Date() }).eq('id', id);
        const t = document.getElementById(`t-${id}`);
        const btn = document.getElementById(`btn-${id}`);
        btn.style.display = "none";
        t.style.display = "block";
        
        if(isGif) t.innerHTML = `<img src="${content}" class="gif-img">`;
        else t.innerText = cipher(content, key, true);

        setTimeout(() => { if(document.getElementById(`msg-${id}`)) document.getElementById(`msg-${id}`).remove(); }, 3000);
    }

    async function loadHistory() {
        document.getElementById('msg-flow').innerHTML = "";
        const { data } = await db.from('messages').select('*').eq('server_id', curServer).is('viewed_at', null);
        if(data) data.forEach(renderMsg);
    }

    // --- INIT ---
    document.getElementById('userInput').addEventListener('keypress', (e) => {
        if(e.key === 'Enter' && e.target.value) { sendMsg(e.target.value); e.target.value = ''; }
    });

    db.channel('elite').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, p => {
        if(p.new.server_id === curServer) renderMsg(p.new);
    }).subscribe();

    renderServers(); renderFriends(); loadHistory();
</script>
</body>
</html>
