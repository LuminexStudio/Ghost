<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GhostDiscord Mod Elite</title>
    <style>
        :root { --neon: #00ff41; --bg-dark: #1e1f22; --bg-light: #313338; --bg-sidebar: #2b2d31; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: sans-serif; }
        body, html { background: #000; color: #fff; margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; position: fixed; }
        #app { display: flex; height: 100dvh; width: 100vw; position: relative; }
        .blur-active { filter: blur(60px) brightness(0); pointer-events: none; }

        /* Navigation */
        .rail { width: 60px; background: #1e1f22; display: flex; flex-direction: column; align-items: center; padding: 10px 0; gap: 10px; border-right: 1px solid #000; overflow-y: auto; flex-shrink: 0; }
        .sidebar { width: 160px; background: var(--bg-sidebar); display: flex; flex-direction: column; border-right: 1px solid #000; flex-shrink: 0; }
        .circle { width: 42px; height: 42px; background: var(--bg-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; font-size: 10px; color: #fff; flex-shrink: 0; object-fit: cover; }
        .active-srv { border-radius: 12px; border: 2px solid var(--neon); }

        /* UI Elements */
        .section-label { padding: 15px 10px 5px 10px; font-size: 9px; font-weight: bold; color: #8e9297; text-transform: uppercase; }
        .item { padding: 8px 10px; margin: 2px 5px; border-radius: 4px; color: #949ba4; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 8px; }
        .active-item { background: #35373c; color: #fff; border-left: 2px solid var(--neon); }

        /* Chat */
        .chat-container { flex: 1; display: flex; flex-direction: column; background: var(--bg-light); min-width: 0; }
        #msg-flow { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg-card { background: #2b2d31; padding: 10px; border-radius: 8px; border-left: 3px solid var(--neon); }
        .chat-pfp { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; object-fit: cover; }
        .msg-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .show-btn { background: var(--neon); color: #000; border: none; padding: 8px; border-radius: 4px; font-weight: bold; width: 100%; cursor: pointer; }
        .secret-content { display: none; padding: 10px; background: #000; border-radius: 4px; word-break: break-all; color: var(--neon); font-family: monospace; }
        
        /* Mod Terminal Style Message */
        .sys-msg { font-size: 10px; color: var(--neon); padding: 5px 10px; border: 1px dashed var(--neon); margin: 5px 0; font-family: monospace; }

        /* Profile Modal */
        #profile-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 280px; background: var(--bg-sidebar); border: 1px solid var(--neon);
            border-radius: 12px; z-index: 10000; display: none; flex-direction: column;
            padding: 20px; text-align: center; box-shadow: 0 0 30px rgba(0,255,65,0.3);
        }
        .profile-pfp { width: 80px; height: 80px; border-radius: 50%; border: 2px solid var(--neon); margin: 0 auto 15px; cursor: pointer; object-fit: cover; background: #000; }
        .bio-area { background: #111; color: var(--neon); border: 1px solid #444; padding: 10px; border-radius: 8px; font-size: 12px; width: 100%; min-height: 60px; margin: 10px 0; outline: none; resize: none; }

        .input-area { padding: 10px; background: var(--bg-dark); border-top: 1px solid #000; display: flex; align-items: center; gap: 10px; }
        input { flex: 1; background: #383a40; border: none; padding: 12px; border-radius: 8px; color: #fff; outline: none; }
        #lockdown { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 99999; display: none; flex-direction: column; justify-content: center; align-items: center; color: var(--neon); }
    </style>
</head>
<body>

<div id="lockdown" onclick="releaseLock()"><h1>ENCRYPTED</h1><p>INTERFERENCE DETECTED</p></div>

<div id="profile-modal">
    <input type="file" id="pfp-input" hidden accept="image/*">
    <img src="" class="profile-pfp" id="p-img" onclick="document.getElementById('pfp-input').click()">
    <h3 id="p-user" style="margin:0">User</h3>
    <textarea id="p-bio" class="bio-area" placeholder="No bio set..."></textarea>
    <button class="show-btn" id="p-save" onclick="saveProfile()">SAVE</button>
    <div style="margin-top:10px; font-size:10px; cursor:pointer; color:#666" onclick="closeProfile()">[ CLOSE ]</div>
</div>

<div id="app">
    <div class="rail" id="srv-list">
        <div class="circle active-srv" onclick="switchServer('main', this)">G</div>
        <div class="circle" onclick="addServer()" style="background:#23a559">+</div>
    </div>
    <div class="sidebar">
        <div class="section-label" id="srv-display">GHOST</div>
        <div class="item active-item" onclick="switchChannel('general', this)"># general</div>
        <div class="section-label">Identity</div>
        <div class="item" onclick="openProfile(myUser)">ðŸ‘¤ My Profile</div>
        <div class="section-label">Friends</div>
        <div id="friend-list"></div>
    </div>
    <div class="chat-container">
        <div id="msg-flow"></div>
        <div class="input-area">
            <input type="text" id="userInput" placeholder="Type /ban name or message..." autocomplete="off">
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const S_URL = 'https://ddtrbxfyhgnbairjdbmk.supabase.co';
    const S_KEY = 'sb_publishable_RvgTk4dJ4ia0lJaPp8Wvaw_xuy48EuH';
    const db = supabase.createClient(S_URL, S_KEY);

    let myUser = localStorage.getItem('ghost_user') || prompt("Username:");
    localStorage.setItem('ghost_user', myUser || "Ghost");

    let curServer = 'main'; let curChannel = 'general';
    const alphabet = "abcdefghijklmnopqrstuvwxyz0123456789 .?!@#".split("");
    const custom = "Î±Î²Î³Î´ÎµÎ¶Î·Î¸Î¹ÎºÎ»Î¼Î½Î¾Î¿Ï€ÏÏƒÏ„Ï…Ï†Ï‡ÏˆÏ‰âš¡âˆ†âˆ‘âˆâˆšâˆžâˆ«â‰ˆâ‰ â‰¤â‰¥â˜…â˜£".split("");

    // --- SECURITY & LOCK ---
    function releaseLock() { document.getElementById('lockdown').style.display='none'; document.getElementById('app').classList.remove('blur-active'); }
    window.addEventListener('blur', () => { document.getElementById('lockdown').style.display='flex'; document.getElementById('app').classList.add('blur-active'); });

    function cipher(t, k, d = false) {
        let r = ""; let s = d ? -k : k;
        for (let c of t.toLowerCase()) {
            let src = d ? custom : alphabet; let tar = d ? alphabet : custom;
            let i = src.indexOf(c); if (i === -1) { r += c; continue; }
            r += tar[(i + s + src.length) % src.length];
        }
        return r;
    }

    // --- COMMAND SYSTEM ---
    async function handleCommand(input) {
        const args = input.split(" ");
        const cmd = args[0].toLowerCase();
        const target = args[1];

        const { data: profile } = await db.from('profiles').select('is_admin').eq('username', myUser).single();
        if (!profile?.is_admin) return systemMessage("PERMISSION DENIED.");

        if (cmd === "/ban" && target) {
            await db.from('banned_users').insert([{ username: target, banned_by: myUser }]);
            systemMessage(`TERMINATED: ${target}`);
        } else if (cmd === "/unban" && target) {
            await db.from('banned_users').delete().eq('username', target);
            systemMessage(`RESTORED: ${target}`);
        } else {
            systemMessage("UNKNOWN COMMAND.");
        }
    }

    function systemMessage(text) {
        const div = document.createElement('div');
        div.className = 'sys-msg';
        div.innerText = `>> ${text}`;
        document.getElementById('msg-flow').appendChild(div);
        document.getElementById('msg-flow').scrollTop = document.getElementById('msg-flow').scrollHeight;
    }

    // --- PROFILE SYSTEM ---
    async function openProfile(user) {
        document.getElementById('profile-modal').style.display = 'flex';
        document.getElementById('p-user').innerText = user;
        const { data } = await db.from('profiles').select('*').eq('username', user).single();
        document.getElementById('p-img').src = data?.avatar_url || `https://ui-avatars.com/api/?name=${user}`;
        document.getElementById('p-bio').value = data?.bio || "No bio yet.";
        document.getElementById('p-bio').readOnly = (user !== myUser);
        document.getElementById('p-save').style.display = (user === myUser) ? 'block' : 'none';
    }

    function closeProfile() { document.getElementById('profile-modal').style.display = 'none'; }
    document.getElementById('pfp-input').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = () => { document.getElementById('p-img').src = reader.result; };
        reader.readAsDataURL(e.target.files[0]);
    };

    async function saveProfile() {
        const bio = document.getElementById('p-bio').value;
        const pfp = document.getElementById('p-img').src;
        await db.from('profiles').upsert({ username: myUser, bio: bio, avatar_url: pfp });
        localStorage.setItem('ghost_pfp', pfp);
        alert("PROFILE SYNCED");
    }

    // --- MESSAGING ---
    async function sendMsg(content) {
        const k = Math.floor(Math.random() * 20) + 1;
        await db.from('messages').insert([{
            content: cipher(content, k),
            secret_key: k.toString(),
            username: myUser,
            server_id: curServer,
            channel_name: curChannel,
            avatar_url: localStorage.getItem('ghost_pfp') || ""
        }]);
    }

    function renderMsg(m) {
        if(document.getElementById(`msg-${m.id}`)) return;
        const div = document.createElement('div');
        div.className = 'msg-card'; div.id = `msg-${m.id}`;
        const pfp = m.avatar_url || `https://ui-avatars.com/api/?name=${m.username}`;
        div.innerHTML = `
            <div class="msg-header">
                <img src="${pfp}" class="chat-pfp" onclick="openProfile('${m.username}')">
                <div style="font-size:10px; color:var(--neon); font-weight:bold; cursor:pointer" onclick="openProfile('${m.username}')">${m.username}</div>
            </div>
            <button class="show-btn" id="btn-${m.id}" onclick="reveal('${m.id}','${m.content}',${m.secret_key})">VIEW (3s)</button>
            <div class="secret-content" id="t-${m.id}"></div>
        `;
        document.getElementById('msg-flow').appendChild(div);
        document.getElementById('msg-flow').scrollTop = document.getElementById('msg-flow').scrollHeight;
    }

    async function reveal(id, content, key) {
        await db.from('messages').update({ viewed_at: new Date() }).eq('id', id);
        const t = document.getElementById(`t-${id}`);
        document.getElementById(`btn-${id}`).style.display = 'none';
        t.style.display = 'block';
        t.innerText = cipher(content, key, true);
        setTimeout(() => { if(document.getElementById(`msg-${id}`)) document.getElementById(`msg-${id}`).remove(); }, 3000);
    }

    async function loadHistory() {
        document.getElementById('msg-flow').innerHTML = "";
        const { data } = await db.from('messages').select('*').eq('server_id', curServer).is('viewed_at', null);
        if(data) data.forEach(renderMsg);
    }

    document.getElementById('userInput').addEventListener('keypress', async (e) => {
        if(e.key === 'Enter' && e.target.value) {
            const val = e.target.value; e.target.value = '';
            if (val.startsWith("/")) {
                await handleCommand(val);
            } else {
                const { data: banned } = await db.from('banned_users').select('*').eq('username', myUser).single();
                if (banned) return systemMessage("ACCESS DENIED: ACCOUNT BLACKLISTED.");
                sendMsg(val);
            }
        }
    });

    db.channel('elite').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, p => {
        if(p.new.server_id === curServer) renderMsg(p.new);
    }).subscribe();

    loadHistory();
</script>
</body>
</html>
