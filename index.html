<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GhostDiscord Elite</title>
    <style>
        :root { --neon: #00ff41; --bg-dark: #1e1f22; --bg-light: #313338; }
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; height: 100vh; overflow: hidden; }
        
        #app { display: flex; height: 100vh; width: 100vw; }
        
        /* SERVER LIST */
        .servers { width: 72px; background: #1e1f22; display: flex; flex-direction: column; align-items: center; padding: 12px 0; gap: 8px; border-right: 1px solid #000; }
        .server-icon { width: 48px; height: 48px; background: var(--bg-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; font-weight: bold; }
        .server-icon:hover, .active-srv { border-radius: 15px; background: var(--neon); color: #000; }

        /* CHANNELS */
        .channels { width: 240px; background: #2b2d31; display: flex; flex-direction: column; }
        .chan-item { padding: 8px 16px; margin: 2px 8px; border-radius: 4px; color: #949ba4; cursor: pointer; }
        .chan-item:hover { background: #35373c; color: #fff; }

        /* CHAT area */
        .chat { flex: 1; background: var(--bg-light); display: flex; flex-direction: column; }
        #msg-flow { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }

        /* ONE-TIME SHOW MESSAGE */
        .msg-card { background: #2b2d31; padding: 12px; border-radius: 8px; border-left: 3px solid var(--neon); position: relative; }
        .msg-meta { font-size: 10px; color: var(--neon); margin-bottom: 5px; opacity: 0.7; }
        .show-btn { background: var(--neon); color: #000; border: none; padding: 5px 10px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .secret-content { display: none; font-family: monospace; padding-top: 5px; word-break: break-all; }
        
        .burning { animation: flash-red 0.5s infinite; }
        @keyframes flash-red { 50% { color: red; } }

        .input-area { padding: 20px; background: var(--bg-light); }
        input { width: 100%; background: #383a40; border: none; padding: 12px; border-radius: 8px; color: #fff; outline: none; box-sizing: border-box; }
    </style>
</head>
<body>

<div id="app">
    <div class="servers">
        <div class="server-icon active-srv" onclick="setServer('main', this)">G</div>
        <div class="server-icon" onclick="addServer()">+</div>
    </div>
    <div class="channels">
        <div style="padding:15px; font-weight:bold; border-bottom:1px solid #222">CHANNELS</div>
        <div class="chan-item" onclick="setChannel('general')"># general</div>
        <div class="chan-item" onclick="setChannel('private')"># private</div>
    </div>
    <div class="chat">
        <div id="msg-flow"></div>
        <div class="input-area">
            <input type="text" id="userInput" placeholder="Message..." autocomplete="off">
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const S_URL = 'https://ddtrbxfyhgnbairjdbmk.supabase.co';
    const S_KEY = 'sb_publishable_RvgTk4dJ4ia0lJaPp8Wvaw_xuy48EuH';
    const db = supabase.createClient(S_URL, S_KEY);

    let myUser = localStorage.getItem('ghost_user') || prompt("Username:");
    let myRole = localStorage.getItem('ghost_role') || "Agent"; 
    localStorage.setItem('ghost_user', myUser);

    let curServer = 'main';
    let curChannel = 'general';

    const alphabet = "abcdefghijklmnopqrstuvwxyz0123456789 .?!@#".split("");
    const custom = "αβγδεζηθικλμνξοπρστυφχψω⚡∆∑∏√∞∫≈≠≤≥★☣".split("");

    function cipher(t, k, d = false) {
        let r = ""; let s = d ? -k : k;
        for (let c of t.toLowerCase()) {
            let src = d ? custom : alphabet; let tar = d ? alphabet : custom;
            let i = src.indexOf(c); if (i === -1) { r += c; continue; }
            r += tar[(i + s + src.length) % src.length];
        }
        return r;
    }

    // --- REALTIME LISTENER ---
    db.channel('elite_room').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, async (p) => {
        const m = p.new;
        if (m.server_id === curServer && m.channel_name === curChannel && !m.viewed_at) {
            renderMessage(m);
        }
    }).subscribe();

    async function renderMessage(m) {
        const flow = document.getElementById('msg-flow');
        const div = document.createElement('div');
        div.className = 'msg-card';
        div.id = `msg-${m.id}`;
        
        div.innerHTML = `
            <div class="msg-meta">[${m.role}] ${m.username}</div>
            <button class="show-btn" id="btn-${m.id}" onclick="reveal('${m.id}', '${m.content}', ${m.secret_key})">SHOW MESSAGE (3s)</button>
            <div class="secret-content" id="content-${m.id}"></div>
        `;
        flow.appendChild(div);
        flow.scrollTop = flow.scrollHeight;
    }

    async function reveal(id, encrypted, key) {
        const btn = document.getElementById(`btn-${id}`);
        const content = document.getElementById(`content-${id}`);
        const card = document.getElementById(`msg-${id}`);

        // 1. Mark as viewed in DB immediately so it can't be fetched again
        await db.from('messages').update({ viewed_at: new Date() }).eq('id', id);

        // 2. Reveal
        btn.style.display = 'none';
        content.innerText = cipher(encrypted, key, true);
        content.style.display = 'block';
        card.classList.add('burning');

        // 3. 3-Second Countdown
        setTimeout(() => {
            card.remove(); // Permanent removal from UI
        }, 3000);
    }

    // --- INTERFACE CONTROLS ---
    function setServer(id, el) {
        curServer = id;
        document.querySelectorAll('.server-icon').forEach(s => s.classList.remove('active-srv'));
        el.classList.add('active-srv');
        document.getElementById('msg-flow').innerHTML = "";
        loadPastMessages();
    }

    function setChannel(ch) {
        curChannel = ch;
        document.getElementById('msg-flow').innerHTML = "";
        loadPastMessages();
    }

    async function loadPastMessages() {
        // Only load messages that have NEVER been viewed
        const { data } = await db.from('messages')
            .select('*')
            .eq('server_id', curServer)
            .eq('channel_name', curChannel)
            .is('viewed_at', null);
        
        if (data) data.forEach(renderMessage);
    }

    document.getElementById('userInput').addEventListener('keypress', async (e) => {
        if (e.key === 'Enter' && e.target.value) {
            const val = e.target.value; e.target.value = '';
            const key = Math.floor(Math.random() * 20) + 1;
            await db.from('messages').insert([{ 
                content: cipher(val, key), 
                secret_key: key, 
                username: myUser, 
                role: myRole,
                server_id: curServer,
                channel_name: curChannel 
            }]);
        }
    });

    loadPastMessages();
</script>
</body>
</html>