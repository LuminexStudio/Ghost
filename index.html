<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GhostDiscord Elite</title>
    <style>
        :root { --neon: #00ff41; --bg-dark: #1e1f22; --bg-light: #313338; --bg-sidebar: #2b2d31; }
        
        /* Base Setup */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; height: 100vh; overflow: hidden; }
        
        #app { display: flex; height: 100vh; width: 100vw; position: relative; z-index: 1; }
        .hidden { filter: blur(60px) brightness(0); pointer-events: none; }

        /* SIDEBARS */
        .servers { width: 65px; background: #1e1f22; display: flex; flex-direction: column; align-items: center; padding: 10px 0; gap: 12px; border-right: 1px solid #000; overflow-y: auto; }
        .sidebar { width: 200px; background: var(--bg-sidebar); display: flex; flex-direction: column; border-right: 1px solid #000; }
        
        /* Mobile adjustment: Hide sidebar on very small screens if needed, but for now we keep it compact */
        @media (max-width: 600px) { .sidebar { width: 140px; } }

        .server-icon { 
            width: 45px; height: 45px; background: var(--bg-light); border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; font-weight: bold; font-size: 10px; flex-shrink: 0;
            color: #fff; border: 2px solid transparent;
        }
        .active-srv { border-radius: 12px; background: var(--neon); color: #000; }

        .section-label { padding: 15px 10px 5px 10px; font-size: 10px; font-weight: bold; color: #8e9297; text-transform: uppercase; }
        .item { padding: 12px 10px; margin: 2px 5px; border-radius: 4px; color: #949ba4; cursor: pointer; font-size: 13px; word-break: break-all; }
        .active-item { background: #35373c; color: #fff; border-left: 2px solid var(--neon); }

        /* CHAT */
        .chat { flex: 1; background: var(--bg-light); display: flex; flex-direction: column; height: 100%; }
        #msg-flow { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }

        /* MESSAGE STYLING */
        .msg-card { background: #2b2d31; padding: 12px; border-radius: 8px; border-left: 3px solid var(--neon); width: 100%; }
        .msg-meta { font-size: 9px; color: var(--neon); margin-bottom: 6px; letter-spacing: 1px; }
        .show-btn { 
            background: var(--neon); color: #000; border: none; padding: 10px; 
            border-radius: 4px; font-weight: bold; cursor: pointer; width: 100%; 
            font-size: 12px; text-transform: uppercase;
        }
        .secret-content { display: none; font-family: monospace; padding: 10px; background: #000; border-radius: 4px; word-break: break-all; color: #fff; font-size: 14px; line-height: 1.4; }

        /* MODALS */
        #settings-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 1000; /* High z-index but buttons inside must work */
            display: none; justify-content: center; align-items: center; 
        }
        .modal-box { background: var(--bg-light); padding: 20px; border-radius: 12px; width: 90%; max-width: 350px; text-align: center; }
        .invite-link { background: #000; padding: 10px; border-radius: 4px; font-size: 11px; color: var(--neon); word-break: break-all; margin: 15px 0; border: 1px solid #444; }

        .input-area { padding: 15px; background: var(--bg-light); border-top: 1px solid #222; }
        input { 
            width: 100%; background: #383a40; border: none; padding: 14px; 
            border-radius: 8px; color: #fff; outline: none; font-size: 16px; /* 16px prevents iOS zoom-in */
        }

        /* SHIELD (Fixed Z-index Issue) */
        #shield { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; z-index: 2000; display: none; 
            flex-direction: column; justify-content: center; align-items: center; 
            color: var(--neon); text-align: center; pointer-events: all;
        }
    </style>
</head>
<body>

<div id="shield" onclick="unlock()">
    <div style="font-size: 24px; font-weight: bold;">ENCRYPTED</div>
    <div style="font-size: 12px; margin-top: 10px;">TAP TO UNLOCK</div>
</div>

<div id="settings-modal">
    <div class="modal-box">
        <h3 style="margin-top:0">Server Settings</h3>
        <p style="font-size:11px; color:#8e9297;">Invite link for <span id="set-srv-name" style="color:var(--neon)"></span>:</p>
        <div class="invite-link" id="invite-display">Select a server...</div>
        <button class="show-btn" onclick="copyInvite()">COPY LINK</button>
        <button class="show-btn" onclick="closeSettings()" style="background:#444; color:#fff; margin-top:10px;">CLOSE</button>
    </div>
</div>

<div id="app">
    <div class="servers" id="server-list">
        <div class="server-icon active-srv" onclick="switchServer('main', this)">MAIN</div>
        <div class="server-icon" onclick="addServer()" style="background:#23a559; color:white; font-size: 20px;">+</div>
    </div>
    
    <div class="sidebar">
        <div class="section-label" id="srv-name-display">MAIN SERVER</div>
        <div class="item" onclick="openSettings()" style="color:var(--neon); font-size:10px; font-weight:bold;">⚙ SETTINGS / INVITE</div>
        
        <div class="section-label">Channels</div>
        <div id="channel-list">
            <div class="item active-item" onclick="switchChannel('general', this)"># general</div>
            <div class="item" onclick="switchChannel('private', this)"># private</div>
        </div>
        
        <div class="section-label">People</div>
        <div id="friend-list"></div>
        <div class="item" onclick="addFriend()" style="color:var(--neon); font-style: italic;">+ Add Person</div>
    </div>

    <div class="chat">
        <div id="msg-flow"></div>
        <div class="input-area">
            <input type="text" id="userInput" placeholder="Message..." autocomplete="off">
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const S_URL = 'https://ddtrbxfyhgnbairjdbmk.supabase.co';
    const S_KEY = 'sb_publishable_RvgTk4dJ4ia0lJaPp8Wvaw_xuy48EuH';
    const db = supabase.createClient(S_URL, S_KEY);

    let myUser = localStorage.getItem('ghost_user') || prompt("Enter Username:");
    if(!myUser) myUser = "User" + Math.floor(Math.random()*999);
    localStorage.setItem('ghost_user', myUser);

    let curServer = 'main';
    let curChannel = 'general';
    const alphabet = "abcdefghijklmnopqrstuvwxyz0123456789 .?!@#".split("");
    const custom = "αβγδεζηθικλμνξοπρστυφχψω⚡∆∑∏√∞∫≈≠≤≥★☣".split("");

    // --- 1. MOBILE-FRIENDLY PROTECTION ---
    const shield = document.getElementById('shield');
    const app = document.getElementById('app');
    
    function lock() { shield.style.display = 'flex'; app.classList.add('hidden'); }
    function unlock() { shield.style.display = 'none'; app.classList.remove('hidden'); }

    // On mobile, blur happens often (pulling down notifications). 
    // We only lock if the window actually loses focus.
    window.addEventListener('blur', lock);
    // On desktop, we can use mouseleave, but on mobile it's better to just use focus.

    // --- 2. CRYPTO ---
    function cipher(t, k, d = false) {
        let r = ""; let s = d ? -k : k;
        for (let c of t.toLowerCase()) {
            let src = d ? custom : alphabet; let tar = d ? alphabet : custom;
            let i = src.indexOf(c); if (i === -1) { r += c; continue; }
            r += tar[(i + s + src.length) % src.length];
        }
        return r;
    }

    // --- 3. SERVER/CHANNEL (FIXED FUNCTIONS) ---
    function addServer() {
        const name = prompt("Enter Server Name (No spaces):");
        if(name) {
            const cleanName = name.replace(/\s+/g, '-').toLowerCase();
            const servers = JSON.parse(localStorage.getItem('ghost_servers') || "[]");
            if(!servers.includes(cleanName)) servers.push(cleanName);
            localStorage.setItem('ghost_servers', JSON.stringify(servers));
            renderServers();
        }
    }

    function renderServers() {
        const list = JSON.parse(localStorage.getItem('ghost_servers') || "[]");
        const container = document.getElementById('server-list');
        // Remove old server icons but keep Main (first) and + (last)
        while(container.children.length > 2) {
            container.removeChild(container.children[1]);
        }
        list.forEach(s => {
            const div = document.createElement('div');
            div.className = 'server-icon';
            if(curServer === s) div.classList.add('active-srv');
            div.innerText = s.substring(0,3).toUpperCase();
            div.onclick = () => switchServer(s);
            container.insertBefore(div, container.lastElementChild);
        });
    }

    function switchServer(id) {
        curServer = id;
        document.getElementById('srv-name-display').innerText = id.toUpperCase();
        renderServers(); // Refresh icons
        refreshChat();
    }

    function switchChannel(id, el) {
        curChannel = id;
        document.querySelectorAll('.item').forEach(i => i.classList.remove('active-item'));
        el.classList.add('active-item');
        refreshChat();
    }

    function refreshChat() {
        document.getElementById('msg-flow').innerHTML = "";
        loadHistory();
    }

    // --- 4. INVITES ---
    function openSettings() {
        const baseUrl = window.location.href.split('?')[0];
        document.getElementById('set-srv-name').innerText = curServer;
        document.getElementById('invite-display').innerText = `${baseUrl}?join=${curServer}`;
        document.getElementById('settings-modal').style.display = 'flex';
    }
    function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
    function copyInvite() {
        const link = document.getElementById('invite-display').innerText;
        navigator.clipboard.writeText(link).then(() => alert("Link Copied!"));
    }

    function checkURLInvites() {
        const params = new URLSearchParams(window.location.search);
        const joinId = params.get('join');
        if (joinId) {
            const servers = JSON.parse(localStorage.getItem('ghost_servers') || "[]");
            if (!servers.includes(joinId)) {
                servers.push(joinId);
                localStorage.setItem('ghost_servers', JSON.stringify(servers));
            }
            window.history.replaceState({}, document.title, window.location.pathname);
            switchServer(joinId);
        }
    }

    // --- 5. CHAT ENGINE ---
    db.channel('elite').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, p => {
        if(p.new.server_id === curServer && p.new.channel_name === curChannel) renderMsg(p.new);
    }).subscribe();

    async function loadHistory() {
        const { data } = await db.from('messages').select('*')
            .eq('server_id', curServer).eq('channel_name', curChannel).is('viewed_at', null);
        if(data) data.forEach(renderMsg);
    }

    function renderMsg(m) {
        if(document.getElementById(`msg-${m.id}`)) return;
        const div = document.createElement('div');
        div.className = 'msg-card';
        div.id = `msg-${m.id}`;
        div.innerHTML = `
            <div class="msg-meta">${m.username.toUpperCase()} • SECURE</div>
            <button class="show-btn" id="btn-${m.id}" onclick="reveal('${m.id}', '${m.content}', ${m.secret_key})">OPEN MESSAGE (3s)</button>
            <div class="secret-content" id="txt-${m.id}"></div>
        `;
        const flow = document.getElementById('msg-flow');
        flow.appendChild(div);
        flow.scrollTop = flow.scrollHeight;
    }

    async function reveal(id, content, key) {
        const txt = document.getElementById(`txt-${id}`);
        const btn = document.getElementById(`btn-${id}`);
        // Burn on DB
        await db.from('messages').update({ viewed_at: new Date() }).eq('id', id);
        btn.style.display = 'none';
        txt.innerText = cipher(content, key, true);
        txt.style.display = 'block';
        setTimeout(() => { 
            const el = document.getElementById(`msg-${id}`);
            if(el) el.remove(); 
        }, 3000);
    }

    function addFriend() {
        const f = prompt("Friend Username:");
        if(f) {
            const friends = JSON.parse(localStorage.getItem('ghost_friends') || "[]");
            friends.push(f);
            localStorage.setItem('ghost_friends', JSON.stringify(friends));
            renderFriends();
        }
    }

    function renderFriends() {
        const list = JSON.parse(localStorage.getItem('ghost_friends') || "[]");
        document.getElementById('friend-list').innerHTML = list.map(f => `<div class="item"><span>● ${f}</span></div>`).join('');
    }

    document.getElementById('userInput').addEventListener('keypress', async (e) => {
        if(e.key === 'Enter' && e.target.value) {
            const val = e.target.value; e.target.value = '';
            const key = Math.floor(Math.random() * 20) + 1;
            await db.from('messages').insert([{ 
                content: cipher(val, key), secret_key: key, 
                username: myUser, server_id: curServer, channel_name: curChannel 
            }]);
        }
    });

    // Start
    checkURLInvites();
    renderServers();
    renderFriends();
    loadHistory();
</script>
</body>
</html>
